<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html lang="en" class="">
  <head>
    <meta charset="utf-8">
    <title>Useful delegation patterns for Rails |  Code.Art.Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta name="description" content="An exploration into the delegation pattern and how it can be useful in various aspects of a Rails application">
    

    <link rel="canonical" href="http://lorefnon.me/2016/01/16/useful-delegation-patterns-for-rails.html">
    <meta property="twitter:creator" content="@lorefnon">
    <meta property="og:title" content="@lorefnon">
    <meta property="og:type" content="blog">
    <meta poperty="og:url" content="http://lorefnon.me">
    <meta property="og:site_name" content="Code.Art.Web">
    <meta property="og:fb:app_id">
    <meta property="og:description" content="An exploration into the delegation pattern and how it can be useful in various aspects of a Rails application">
    <link rel="alternate" type="application/rss+xml" href="http://lorefnon.me/feed.xml"/>
    <link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/reset.css"/>
    <link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/responsive.css"/>
    <link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/github.css"/>
    <link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/minimal_lightbox.css"/>
    <link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/styles.css"/>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Raleway" rel='stylesheet' type='text/css'>
    <script>
  this.top.location !== this.location && (this.top.location = this.location);
</script>

  </head>
  <body style="zoom: 1;">
    <div class="main-container">

      <div class="mlogotype is-uppercase">
        <a href="http://lorefnon.me">Code.Art.Web</a>
      </div>

      <a href="http://lorefnon.me" class="home_logotype_link">
        <h1 class="tag">Code.Art.Web</h1>
      </a>

      <div class="header-container detail-view">
        <header class="main-header">
          <figure class="avatar">
            <a href="http://lorefnon.me"
            style="background-image: url();">Profile Picture</a>
          </figure>
          <h1 class="profile-name is-uppercase">
            <a href="http://lorefnon.me">Lorefnon</a>
          </h1>
        </header>
      </div>

      <div class="posts-container detail-view">
        <article class="post detail-view" id="">
          <h1 class="title"><a href="#">Useful delegation patterns for Rails</a></h1>
          <a href="#" class="anchor-icon time-wrapper">
            <i class="fa fa-anchor"></i>
            <time>Jan 16, 2016</time>
          </a>

          
          <h2> <a class="header-link" href="#abstract" id="abstract"> Abstract </a> </h2>
          <p>An exploration into the delegation pattern and how it can be useful in various aspects of a Rails application</p>

          

          

          <div id="toc-container"><table class="toc" id="toc"><tbody><tr><td>
<div id="toctitle"><h2><a class="header-link" href="#contents" id="contents">Contents</a></h2></div>
<ul>
<li class="toc_level-1 toc_section-1"><a href="#header1-1"><span class="tocnumber">1.</span> <span class="toctext">About delegation</span></a></li>
<li class="toc_level-1 toc_section-2"><a href="#header1-2"><span class="tocnumber">2.</span> <span class="toctext">Implementing Delegators in Ruby</span></a></li>
<li class="toc_level-1 toc_section-3">
<a href="#header1-3"><span class="tocnumber">3.</span> <span class="toctext">Wrapping objects with SimpleDelegator</span></a><ul>
<li class="toc_level-2 toc_section-4"><a href="#header1-3-1"><span class="tocnumber">3.1.</span> <span class="toctext">Using delegation for Presenter logic</span></a></li>
<li class="toc_level-2 toc_section-5"><a href="#header1-3-2"><span class="tocnumber">3.2.</span> <span class="toctext">Delegation for memoization/caching</span></a></li>
<li class="toc_level-2 toc_section-6"><a href="#header1-3-3"><span class="tocnumber">3.3.</span> <span class="toctext">Using delegation for collection objects</span></a></li>
<li class="toc_level-2 toc_section-7"><a href="#header1-3-4"><span class="tocnumber">3.4.</span> <span class="toctext">Using delegation to augment lifecycle hooks</span></a></li>
</ul>
</li>
<li class="toc_level-1 toc_section-8">
<a href="#header1-8"><span class="tocnumber">4.</span> <span class="toctext">In Rails, any module can delegate</span></a><ul>
<li class="toc_level-2 toc_section-9"><a href="#header1-8-1"><span class="tocnumber">4.1.</span> <span class="toctext">Delegating helpers to model instances:</span></a></li>
<li class="toc_level-2 toc_section-10"><a href="#header1-8-2"><span class="tocnumber">4.2.</span> <span class="toctext">Chaining delegators</span></a></li>
</ul>
</li>
<li class="toc_level-1 toc_section-11"><a href="#header1-11"><span class="tocnumber">5.</span> <span class="toctext">Delegation as an alternative to Concerns</span></a></li>
<li class="toc_level-1 toc_section-12"><a href="#header1-12"><span class="tocnumber">6.</span> <span class="toctext">Delegation in command line applications</span></a></li>
<li class="toc_level-1 toc_section-13"><a href="#header1-13"><span class="tocnumber">7.</span> <span class="toctext">Some alternatives</span></a></li>
</ul>
</td></tr></tbody></table></div>
<h2><a class="header-link" href="#header1-1" id="header1-1"><span class="header-bullet-num">1.</span><span class="header-inner-text">About delegation</span></a></h2>

<p>Delegation is a very useful software pattern and this post focusses on how this pattern can be applied in the context of a Rails application and the associated advantages of doing so.</p>

<p>If you are unfamiliar with this pattern, <a href="https://en.wikipedia.org/wiki/Delegation_pattern">Wikipedia</a> has a very good explanation: </p>

<blockquote>
<p>In software engineering, the delegation pattern is a design pattern in object-oriented programming where an object, instead of performing one of its stated tasks, delegates that task to an associated helper object.</p>

<p>There is an Inversion of Responsibility in which a helper object, known as a delegate, is given the responsibility to execute a task for the delegator.</p>
</blockquote>

<p>Also, this <a href="http://stackoverflow.com/questions/7168714/what-is-the-purpose-of-a-delegation-pattern">Stackoverflow post</a> has some interesting posts elaborating on the practical benefits of the concepts of delegation in a language neutral context.</p>

<h2><a class="header-link" href="#header1-2" id="header1-2"><span class="header-bullet-num">2.</span><span class="header-inner-text">Implementing Delegators in Ruby</span></a></h2>

<p>Ruby's metaprogramming facilities enable us to implement delegation in a much easier and consise manner than many other object oriented languages.</p>

<p>Using dynamic interception of method calls, it is very straightforward to forward method invocations to a target object. This is very well illustrated by the <a href="https://github.com/ruby/ruby/blob/trunk/lib/delegate.rb#L75-L89">implementation</a> of <a href="https://github.com/sj26/ruby-1.9.3-p0/blob/master/lib/delegate.rb">Delegate class</a> provided by Ruby standard library:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Delegator</span> <span class="o">&lt;</span> <span class="no">BasicObject</span>

  <span class="c1">#...</span>

  <span class="c1">#</span>
  <span class="c1"># Handles the magic of delegation through \_\_getobj\_\_.</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">target</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">__getobj__</span> <span class="p">{</span><span class="n">r</span> <span class="o">=</span> <span class="kp">false</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
      <span class="n">target</span><span class="o">.</span><span class="n">__send__</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="o">::</span><span class="no">Kernel</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
      <span class="o">::</span><span class="no">Kernel</span><span class="o">.</span><span class="n">instance_method</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">super</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<h2><a class="header-link" href="#header1-3" id="header1-3"><span class="header-bullet-num">3.</span><span class="header-inner-text">Wrapping objects with SimpleDelegator</span></a></h2>

<p>In practice we usually deal with <a href="http://ruby-doc.org/stdlib-2.1.0/libdoc/delegate/rdoc/SimpleDelegator.html"><code>SimpleDelegator</code></a> subclass of <code>Delegator</code> more often. The constructor takes a single object and any method invocations are delegated to the target instance. </p>

<p>We can simply subclass from <code>SimpleDelegator</code> and implement our customizations therein, and delegating to the parent object through a <code>super</code> call conveniently.</p>

<p>Example from docs:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nf">born_on</span>
    <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1989</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UserDecorator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>
  <span class="k">def</span> <span class="nf">birth_year</span>
    <span class="n">born_on</span><span class="o">.</span><span class="n">year</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="no">UserDecorator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</code></pre></div>
<h3><a class="header-link" href="#header1-3-1" id="header1-3-1"><span class="header-bullet-num">3.1.</span><span class="header-inner-text">Using delegation for Presenter logic</span></a></h3>

<p>This is arguably the most common use case for delegators. Often we end up adding a lot of methods in our models that have nothing to do with domain logic whatsoever. Does something like this look familiar?</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">User</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">formatted_date_of_birth</span>
    <span class="n">date_of_birth</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"Born on %m/%d/%Y"</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>Such methods which are primarily written for handling presentation concerns come into the perview of Presenter logic and are best left out of models. Instead we can decorate our model instances using presenter classes before passing them to views:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UserDecorator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>

 <span class="k">def</span> <span class="nf">formatted_date_of_birth</span>
  <span class="n">date_of_birth</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"Born on %m/%d/%Y"</span><span class="p">)</span>
 <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserDecorator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>I find this to be more elegant from an object oriented perspective compared to the conventional approach using Rails helper modules.</p>

<p>There are many <a href="https://www.ruby-toolbox.com/categories/rails_presenters">libraries</a> for implementing additional convenience utilities around presenters. While the above simple approach takes you quite far, if you find yourself repeating the decorator instantiation boilerplate, generators and conventions offered by a library like <a href="https://github.com/drapergem/draper">Draper</a> can be helpful.</p>

<p>Note that one of the biggest strengths of decorators is on demand composability. For instance we may have various user centric helper methods for reporting. We can extract them in a <code>UserReportPresenter</code> decorator that is used only in the <code>UserReportsController</code>.</p>

<p>We may want to have some approach to restrict what can be decorated by a decorator. We may be tempted to define something like this:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UserReportPresenter</span> <span class="o">&lt;</span> <span class="no">SimpleDecorator</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">decorated</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">decorated</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">User</span>
      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Expected entity being decorated to be User"</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">super</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>However this is not something we would want to do as it breaks composability. One approach would be to "unwrap" the decorated before instance check:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">while</span> <span class="n">decorated</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Decorator</span>
  <span class="n">decorated</span> <span class="o">=</span> <span class="n">decorated</span><span class="o">.</span><span class="n">__getobj__</span>
<span class="k">end</span>
<span class="k">unless</span> <span class="n">decorated</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">User</span>
  <span class="k">raise</span> <span class="no">ArgumentError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Expected entity being decorated to be User"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>but I strongly recommend not resorting to <code>is_a?</code> checks at all and rely on behavior checks using <code>responds_to?</code>.</p>

<h3><a class="header-link" href="#header1-3-2" id="header1-3-2"><span class="header-bullet-num">3.2.</span><span class="header-inner-text">Delegation for memoization/caching</span></a></h3>

<p>This is another good use case for delegation. We can wrap our models into Delegators that transparently cache or memoize method invocations:</p>

<p>Example using <code>Rails.cache</code>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UserReportCachedDelegator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>

  <span class="k">def</span> <span class="nf">annual_performance_stats</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">fetch</span> <span class="s2">"user.</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.annual_performance_stats"</span> <span class="k">do</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>However one thing that we should keep in mind that SimpleDelegator allows the decorated target to be run time configurable. While this is not a problem in the above implementation as we use an entity specific key, this may become a problem if, for example, we were using transparent memoization through <a href="https://github.com/matthewrudy/memoist">Memoist</a>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UserReportMemoizedDelegator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>

  <span class="kp">extend</span> <span class="no">Memoist</span>

  <span class="k">def</span> <span class="nf">annual_performance_stats</span><span class="p">;</span> <span class="k">super</span><span class="p">;</span> <span class="k">end</span>
  <span class="n">memoize</span> <span class="ss">:annual_performance_stats</span>

<span class="k">end</span>
</code></pre></div>
<p>The above implementation is broken because even if we were to change the decorated instance using <code>__setobj__</code> our memoized method would continue returning the output of invocation of the method on previously decorated instance.</p>

<p>A simple solution for the above is to flush the cache when the decorated entity changes:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MemoizedDelegator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>

  <span class="kp">extend</span> <span class="no">Memoist</span>

   <span class="k">def</span> <span class="nf">__setobj__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
     <span class="k">super</span>
     <span class="n">flush_cache</span>
   <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<h3><a class="header-link" href="#header1-3-3" id="header1-3-3"><span class="header-bullet-num">3.3.</span><span class="header-inner-text">Using delegation for collection objects</span></a></h3>

<p>This is something I recently found to be useful. Sometimes when we need to define operations that make sense for a set of instances, we just resort to class methods in model. However a better object oriented design would be to implement such behaviors on a dedicated collection resource.</p>

<p>Decorating <code>ActiveRecord::CollectionProxy</code> is helpful because we get facilities like scope chaining, lazy-loading etc. for free.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">EmployeesReportDelegator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>

  <span class="k">def</span> <span class="nf">month_wise_performance_stats</span>
    <span class="n">joins</span><span class="p">(</span><span class="ss">:assessments</span><span class="p">)</span>
      <span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">'MONTH(assessments.created_at)'</span><span class="p">)</span>
      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'assessments.evaluation_rank as rank'</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<h3><a class="header-link" href="#header1-3-4" id="header1-3-4"><span class="header-bullet-num">3.4.</span><span class="header-inner-text">Using delegation to augment lifecycle hooks</span></a></h3>

<p>This is occassionaly useful especially when dealing with third party SDKs. We can leverage <code>ActiveSupport::Callbacks</code> to wrap custom callback hooks around specific behaviors of decorated objects:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MailDispatchDelegator</span> <span class="o">&lt;</span> <span class="no">SimpleDelegator</span>

  <span class="kp">include</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Callbacks</span>
  <span class="n">define_callbacks</span> <span class="ss">:dispatch</span>

  <span class="k">def</span> <span class="nf">dispatch</span>
    <span class="n">run_callbacks</span> <span class="ss">:dispatch</span> <span class="k">do</span>
      <span class="k">super</span>      
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="k">class</span> <span class="nc">MailFilterDelegator</span> <span class="o">&lt;</span> <span class="no">MailDispatchDelegator</span>

  <span class="n">set_callback</span> <span class="ss">:dispatch</span><span class="p">,</span> <span class="ss">:before</span> <span class="k">do</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">validated_domains</span><span class="o">.</span><span class="n">include?</span> <span class="n">object</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">domain</span>
      <span class="k">raise</span> <span class="no">ValidationError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Domain not whitelisted"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<h2><a class="header-link" href="#header1-8" id="header1-8"><span class="header-bullet-num">4.</span><span class="header-inner-text">In Rails, any module can delegate</span></a></h2>

<p>While creating a dedicated Delegator makes sense in a variety of use cases, often we want to just delegate a few methods to a contained object.  ActiveSupport Module extensions provide a convenient approach to delegate specific methods to any contained object. This comes in very handy in controllers:</p>

<h3><a class="header-link" href="#header1-8-1" id="header1-8-1"><span class="header-bullet-num">4.1.</span><span class="header-inner-text">Delegating helpers to model instances:</span></a></h3>

<p>For example in a rails controller, we might want to expose a few model methods:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_action</span> <span class="ss">:ensure_logged_in!</span>
  <span class="n">delegate</span> <span class="ss">:available_products</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:current_user</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@available_products</span> <span class="o">=</span> <span class="n">available_products</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>We can also simply expose the delegated methods as a helper_method to our views:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_action</span> <span class="ss">:ensure_logged_in!</span>
  <span class="n">delegate</span> <span class="ss">:available_products</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:current_user</span>
  <span class="n">helper_method</span> <span class="ss">:available_products</span>

<span class="k">end</span>
</code></pre></div>
<p>I have found this to be a common use case, and a class method that wraps the two can help in DRYing things up:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delegate_helper</span> <span class="o">*</span><span class="n">args</span>
  <span class="n">delegate</span> <span class="o">*</span><span class="n">args</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">break</span> <span class="k">unless</span> <span class="n">method_name</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Symbol</span>
    <span class="n">helper_method</span> <span class="n">method_name</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The above method allows us to take advantage of full api of <code>Module#delegate</code> which allows delegation of multiple methods to single target and configuration of generated method.</p>

<p>So for example, we can do the following:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">SomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">before_action</span> <span class="ss">:ensure_logged_in!</span>
  <span class="n">delegate_helper</span> <span class="ss">:designations</span><span class="p">,</span> <span class="ss">:products</span><span class="p">,</span> 
                  <span class="ss">to</span><span class="p">:</span> <span class="ss">:current_user</span><span class="p">,</span> 
                  <span class="ss">prefix</span><span class="p">:</span> <span class="kp">true</span>

<span class="k">end</span>
</code></pre></div>
<p>Now delegated methods would be available as <code>current_user_designations</code> and <code>current_user_products</code> in our views.</p>

<p><code>Module#delegate</code> works very well with instance variables and class variables as well. Here is an example from the <a href="http://api.rubyonrails.org/classes/Module.html#method-i-delegate">official documentation</a> :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Foo</span>
  <span class="no">CONSTANT_ARRAY</span> <span class="o">=</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">]</span>
  <span class="vc">@@class_array</span>  <span class="o">=</span> <span class="o">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@instance_array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">delegate</span> <span class="ss">:sum</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:CONSTANT_ARRAY</span>
  <span class="n">delegate</span> <span class="ss">:min</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:@@class_array</span>
  <span class="n">delegate</span> <span class="ss">:max</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:@instance_array</span>
<span class="k">end</span>

<span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">sum</span> <span class="c1"># =&gt; 6</span>
<span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">min</span> <span class="c1"># =&gt; 4</span>
<span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">max</span> <span class="c1"># =&gt; 11</span>
</code></pre></div>
<h3><a class="header-link" href="#header1-8-2" id="header1-8-2"><span class="header-bullet-num">4.2.</span><span class="header-inner-text">Chaining delegators</span></a></h3>

<p>As you may have inferred at this point, we can easily chain delegated invocations:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">class ProductsController &lt; ApplicationController

  before_action :ensure_logged_in!
  delegate :manager, to: :current_user
  delegate :designation, to: :manager, prefix: :manager

end
</code></pre></div>
<h2><a class="header-link" href="#header1-11" id="header1-11"><span class="header-bullet-num">5.</span><span class="header-inner-text">Delegation as an alternative to Concerns</span></a></h2>

<p>Since the official endorsement of concerns from Rails 4 concerns have soared in popularity, however I have often observend that concerns are overused, especially for use cases that are better handled by other patterns.</p>

<p>Since this post is about delegation, let us look at a few things that delegation has to offer over concerns:</p>

<ul>
<li>
<p>Run time configurability:</p>

<p>While it is true that concerns can be injected at run time, however code that runs in the included hooks potentially modifies the host instance making run time switching of concerns not very practical in most cases. Delegation offers a clearer approach and we have already demonstrated that switching delegated instances in delegator instances is quite useful.</p>
</li>
<li>
<p>On demand specialization:</p>

<p>This is particularly useful for objects that did not originate in our code. Rather than polluting the library generated objects with application specific behavior, which may cause subtle unintended side-effects, it is much more elegant to pass around decorated instances in application code and pass the unwrapped instances back to the library should there be a need to do so.</p>
</li>
</ul>

<p>All in all concnerns are more suitable for application specific classes where core functionality is shared among multiple classes, and delegation is more useful for implementing auxiliary use case specific behaviors or transparently augmenting existing behavior. </p>

<p>A good example of former use case would be a cross-cutting functionality like using a <code>completed_at</code> column for scoping on completion status or checking if a model (eg. Payment, Project etc.) has been completed  :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">CompletionSupport</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>

    <span class="o">%</span><span class="n">i</span><span class="o">[</span><span class="n">complete</span> <span class="n">completed</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
      <span class="n">scope</span> <span class="nb">name</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'completed_at is not null'</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">scope</span> <span class="ss">:incomplete</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="n">completed_at</span><span class="p">:</span> <span class="kp">nil</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">complete!</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">completed_at</span> <span class="o">=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span>
    <span class="n">save!</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">complete?</span>
    <span class="n">completed_at</span><span class="o">.</span><span class="n">present?</span>
  <span class="k">end</span>

  <span class="n">alias_method</span> <span class="ss">:completed?</span><span class="p">,</span> <span class="ss">:complete?</span>

  <span class="k">def</span> <span class="nf">incomplete?</span>
    <span class="o">!</span> <span class="n">complete?</span>
  <span class="k">end</span>

  <span class="n">alias_method</span> <span class="ss">:not_completed?</span><span class="p">,</span> <span class="ss">:incomplete?</span>

<span class="k">end</span>
</code></pre></div>
<h2><a class="header-link" href="#header1-12" id="header1-12"><span class="header-bullet-num">6.</span><span class="header-inner-text">Delegation in command line applications</span></a></h2>

<p>Last but not the least, delegation makes sense in command line applications as well. An excellent example would be github's hub command line utility that makes a lot of github features like <code>pull-requests</code> accessible from the command line, while delegating everything else to git.</p>

<h2><a class="header-link" href="#header1-13" id="header1-13"><span class="header-bullet-num">7.</span><span class="header-inner-text">Some alternatives</span></a></h2>

<ul>
<li>Observers</li>
</ul>

<p>While observer pattern can help towards decoupling and the advantags therein overlap with those offered by delegates in some cases, in general I refrain from using Observer pattern because it makes the flow of logic harder to trace - especially in larger applications.</p>

<ul>
<li>Refinements</li>
</ul>

<p>Refinements are a recent addition to the Ruby language where in we can selectively monkey-patch modules (and hence classes) with custom behavior. But a key aspect of refinements is lexical scoping. The offical docs explain this very well:</p>

<blockquote>
<p>Refinements are lexical in scope. When control is transferred outside the scope the refinement is deactivated. This means that if you require or load a file or call a method that is defined outside the current scope the refinement will be deactivated:</p>
</blockquote>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">C</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">M</span>
  <span class="n">refine</span> <span class="n">C</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">foo</span>
      <span class="nb">puts</span> <span class="s2">"C#foo in M"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">call_foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">x</span><span class="o">.</span><span class="n">foo</span>
<span class="k">end</span>

<span class="n">using</span> <span class="n">M</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">new</span>
<span class="n">x</span><span class="o">.</span><span class="n">foo</span>       <span class="c1"># prints "C#foo in M"</span>
<span class="n">call_foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1">#=&gt; raises NoMethodError</span>
</code></pre></div>
<p>While this explicit aspect of Refinements is a commendable improvement over adhoc monkey-patching in many scenarios - the convenience offered by transparent overlaying of behavior that decorators offer us, has so far seemed to be more appealing in most practical cases.</p>

<p>The primary exception to the above would be cases where the code consuming the augmented instances rely on <code>instance_of?</code> checks to determine the identity of passed instance. Using refinements we are not changing the class of the instance, where as while passing the wrapped instance we fail on the <code>instance_of?</code> checks as the wrapped instances are actually instances of a different class though they implement interchangeable behavior.</p>

<p>This concludes our post on delegation. As always any insights on practical usage of this pattern is more than welcome. Please use the comments section to share any feedback or criticism.</p>


<footer class="group">
  <p>
    
    
    
      
    
  </p>
</footer>
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//lorefnon-blog.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" class="disqus-link">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink disqus-link">comments powered by <span class="logo-disqus">Disqus</span></a>



        </article>
      </div>

      <div class="line hide-text">Separator line</div>

      <!-- Next article preview -->
      <div class="next-article" style="display: none;">
        <a href="#">
          <p class="read-next tag is-uppercase">Read this next:</p>
          <p class="next-article__title">Protocol and Language</p>
          <div class="next-article__content">
            <p>This is the second part of my series on protocol. The first part contained a lot of background information, but now we’re ready to get into what Protocol actually is. I live in a pretty unique place, the Farmhouse. It’s a... <span>Continue…</span></p>
          </div>
        </a>
      </div>
      <!-- Finish / Feature on process-->

      <div class="line hide-text">Separator line</div>

      <div class="foot_logo">
        <a href="http://lorefnon.me"><span class="logo"></span></a>
      </div>

      <div class="foot_logo right">
        <a href="/"><span class="link">Full Blog >></span></a>
      </div>

      <div class="line"></div>

<div class="foot_userbar">
  <div href="#" class="bottom_tagline">
    <span>Lorefnon</span>
    <br><br>
    <p> Full stack web developer and polyglot programmer with strong interest in dynamic languages, web application development and user experience design. </p>
    <br>
    <p> Strong believer in agile methodologies, behaviour driven development and efficacy of open source technologies.</p>
    <br>
  </div>
  <div class="profile-links-container">
  <a href="#" class="bottom_tagline"><span> You can reach me through :</span></h2>
  <br><br>
  <ul class="profile-links">
    <li class="twitter">
      <a href="http://twitter.com/lorefnon" target="_blank">
        <span>Twitter</span>
      </a>
    </li>
    <li class="linkedin">
      <a href="https://in.linkedin.com/in/gaurab-paul-a2472921" target="_blank">
        <span>Linkedin</span>
      </a>
    </li>
    <li class="github">
      <a href="https://github.com/lorefnon" target="_blank">
        <span>Github</span>
      </a>
    </li>
    <li class="github">
      <a href="mailto:lorefnon@gmail.com" target="_blank">
        <span>Email</span>
      </a>
    </li>
  </ul>

  </div>
</div>
<div class="line"></div>
<div class="foot_userbar">
  <p>&copy; 2013 - 2015 Gaurab Paul </p>
<br/>
<p>Code licensed under the
  <a href="http://opensource.org/licenses/MIT" target="_blank">The
    MIT License</a>. Content and Artwork licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA</a>.
</p>
<br/>
<p>
  The opinions expressed herein are my personal viewpoints  and may
  not be taken as professional recommendations from any of my previous or
  current employers.
</p>
<br/>
<p>
  Site is powered by <a href="http://jekyllrb.com/">Jekyll</a> and graciously hosted by <a href="https://github.com">Github</a>
</p>
<br/>
<br/>

</div>

    </div>

    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-47274059-1']);
  _gaq.push(['_setDomainName', 'lorefnon.me']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

    <script src="/assets/javascripts/post.js"></script>
  </body>
</html>
