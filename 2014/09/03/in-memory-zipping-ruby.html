<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]--><!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]--><!--[if gt IE 8]>><!<![endif]--><html lang="en" class=""><head><meta charset="utf-8"><title>In-Memory Zipping in Ruby | Code.Art.Web</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="http://lorefnon.me/2014/09/03/in-memory-zipping-ruby.html"><meta property="twitter:creator" content="@lorefnon"><meta property="og:title" content="@lorefnon"><meta property="og:type" content="blog"><meta poperty="og:url" content="http://lorefnon.me"><meta property="og:site_name" content="Code.Art.Web"><meta property="og:fb:app_id"><meta property="og:description" content=""><link rel="alternate" type="application/rss+xml" href="http://lorefnon.me/feed.xml"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/reset.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/responsive.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/github.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/minimal_lightbox.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/styles.css"/><link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"><link href="//fonts.googleapis.com/css?family=Raleway" rel='stylesheet' type='text/css'> <script>this.top.location!==this.location&&(this.top.location=this.location)</script></head><body style="zoom:1"><div class="main-container"><div class="mlogotype is-uppercase"> <a href="http://lorefnon.me">Code.Art.Web</a></div><a href="http://lorefnon.me" class="home_logotype_link"><h1 class="tag">Code.Art.Web</h1> </a><div class="header-container detail-view"> <header class="main-header"> <figure class="avatar"> <a href="http://lorefnon.me" style="background-image:url('')">Profile Picture</a> </figure><h1 class="profile-name is-uppercase"> <a href="http://lorefnon.me">Lorefnon</a></h1> </header></div><div class="posts-container detail-view"> <article class="post detail-view" id=""><h1 class="title"><a href="#">In-Memory Zipping in Ruby</a></h1> <a href="#" class="anchor-icon time-wrapper"> <i class="fa fa-anchor"></i> <time>Sep 03, 2014</time> </a><p><a href="https://github.com/rubyzip/rubyzip">Rubyzip</a> is pretty much the defacto solution for manipulating zip files in ruby. However an underdocumented feature of this library is that it allows for creating zip files in memory ie. without actually writing anything to a file.</p><p>There are many situations when this can come in handy. For example in a Web application it may be faster to zip a small number of files on the fly and deliver it to client without writing to disc. This is especially handy in cloud environments where direct disc access is prohibited.</p><p>This can be accomplished as follows:</p><div class="highlight"><pre><code class="ruby"><span class="n">file_stream</span> <span class="o">=</span> <span class="no">Zip</span><span class="o">::</span><span class="no">ZipOutputStream</span><span class="o">.</span><span class="n">write_buffer</span> <span class="k">do</span> <span class="o">|</span><span class="n">zip</span><span class="o">|</span>
  <span class="n">zip</span><span class="o">.</span><span class="n">put_next_entry</span> <span class="s2">"hello.txt"</span>
  <span class="n">zip</span><span class="o">.</span><span class="n">print</span> <span class="s2">"Hello World"</span>
<span class="k">end</span>
</code></pre></div><p>The above creates a zip file with a single file hello.txt containing the text "Hello World"</p><p>Creating directory structures is just as easy:</p><div class="highlight"><pre><code class="ruby"><span class="n">file_stream</span> <span class="o">=</span> <span class="no">Zip</span><span class="o">::</span><span class="no">ZipOutputStream</span><span class="o">.</span><span class="n">write_buffer</span> <span class="k">do</span> <span class="o">|</span><span class="n">zip</span><span class="o">|</span>
  <span class="n">zip</span><span class="o">.</span><span class="n">put_next_entry</span> <span class="s2">"dir1/hello.txt"</span>
  <span class="n">zip</span><span class="o">.</span><span class="n">print</span> <span class="s2">"Hello"</span>
  <span class="n">zip</span><span class="o">.</span><span class="n">put_next_entry</span> <span class="s2">"dir2/hello.txt"</span>
  <span class="n">zip</span><span class="o">.</span><span class="n">print</span> <span class="s2">"World"</span>
<span class="k">end</span>
</code></pre></div><p>Finally, before we can read from the stream we will have to rewind it first. As an illustrative example the following shows a typical Rails controller that renders a zipped file to client.</p><div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">SomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">some_action</span>
    <span class="n">file_stream</span> <span class="o">=</span> <span class="no">Zip</span><span class="o">::</span><span class="no">ZipOutputStream</span><span class="o">.</span><span class="n">write_buffer</span> <span class="k">do</span> <span class="o">|</span><span class="n">zip</span><span class="o">|</span>
      <span class="n">zip</span><span class="o">.</span><span class="n">put_next_entry</span> <span class="s2">"dir1/hello.txt"</span>
      <span class="n">zip</span><span class="o">.</span><span class="n">print</span> <span class="s2">"Hello"</span>
      <span class="n">zip</span><span class="o">.</span><span class="n">put_next_entry</span> <span class="s2">"dir2/hello.txt"</span>
      <span class="n">zip</span><span class="o">.</span><span class="n">print</span> <span class="s2">"World"</span>
    <span class="k">end</span>
    <span class="n">file_stream</span><span class="o">.</span><span class="n">rewind</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">zip</span> <span class="k">do</span>
        <span class="n">send_data</span> <span class="n">file_stream</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="ss">filename</span><span class="p">:</span> <span class="s2">"zip_file.zip"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>A user visiting this action will be downloading a file named zip_file.zip containing two files in their respective directories.</p><p>For <code>format.zip</code> to be available we will have to register <code>application/zip</code> mimetype. Add the following to an initializer:</p><div class="highlight"><pre><code class="ruby"><span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="o">.</span><span class="n">register</span> <span class="s2">"application/zip"</span><span class="p">,</span> <span class="ss">:zip</span>
</code></pre></div><p>This concludes this small article. Please feel free to leave your suggestions in the comments below.</p><footer class="group"><p></p> </footer><div id="disqus_thread"></div> <script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//lorefnon-blog.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" class="disqus-link">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class="dsq-brlink disqus-link">comments powered by <span class="logo-disqus">Disqus</span></a></article></div><div class="line hide-text">Separator line</div><div class="next-article" style="display:none"> <a href="#"><p class="read-next tag is-uppercase">Read this next:</p><p class="next-article__title">Protocol and Language</p><div class="next-article__content"><p>This is the second part of my series on protocol. The first part contained a lot of background information, but now we’re ready to get into what Protocol actually is. I live in a pretty unique place, the Farmhouse. It’s a... <span>Continue…</span></p></div> </a></div><div class="line hide-text">Separator line</div><div class="foot_logo"> <a href="http://lorefnon.me"><span class="logo"></span></a></div><div class="foot_logo right"> <a href="/"><span class="link">Full Blog >></span></a></div><div class="line"></div><div class="foot_userbar"><div href="#" class="bottom_tagline"> <span>Lorefnon</span> <br><br><p> Full stack web developer and polyglot programmer with strong interest in dynamic languages, web application development and user experience design.</p> <br><p> Strong believer in agile methodologies, behaviour driven development and efficacy of open source technologies.</p> <br></div><div class="profile-links-container"> <a href="#" class="bottom_tagline"><span> You can reach me through :</span></h2> <br><br><ul class="profile-links"><li class="twitter"> <a href="http://twitter.com/lorefnon" target="_blank"> <span>Twitter</span> </a></li><li class="linkedin"> <a href="https://in.linkedin.com/in/gaurab-paul-a2472921" target="_blank"> <span>Linkedin</span> </a></li><li class="github"> <a href="https://github.com/lorefnon" target="_blank"> <span>Github</span> </a></li><li class="github"> <a href="mailto:lorefnon@gmail.com" target="_blank"> <span>Email</span> </a></li></ul></div></div><div class="line"></div><div class="foot_userbar"><p>© 2013 - 2015 Gaurab Paul</p> <br/><p>Code licensed under the <a href="http://opensource.org/licenses/MIT" target="_blank">The MIT License</a>. Content and Artwork licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA</a>.</p> <br/><p> The opinions expressed herein are my personal viewpoints and may not be taken as professional recommendations from any of my previous or current employers.</p> <br/><p> Site is powered by <a href="http://jekyllrb.com/">Jekyll</a> and graciously hosted by <a href="https://github.com">Github</a></p> <br/> <br/></div></div><script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-47274059-1"]),_gaq.push(["_setDomainName","lorefnon.me"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="/assets/javascripts/post.js"></script></body></html>