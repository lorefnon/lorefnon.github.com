<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]--><!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]--><!--[if gt IE 8]>><!<![endif]--><html lang="en" class=""><head><meta charset="utf-8"><title>Boost your content focussed site with Structured Page Fragments | Code.Art.Web</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Eliminate full page refreshes and reduce page transition latency, in your your Rails sites, using SPF.js &amp;mdash; a library for dynamic page updates from Youtube."><link rel="canonical" href="http://lorefnon.me/2015/11/26/boost-your-content-focussed-site-with-structured-page-fragments.html"><meta property="twitter:creator" content="@lorefnon"><meta property="og:title" content="@lorefnon"><meta property="og:type" content="blog"><meta poperty="og:url" content="http://lorefnon.me"><meta property="og:site_name" content="Code.Art.Web"><meta property="og:fb:app_id"><meta property="og:description" content="Eliminate full page refreshes and reduce page transition latency, in your your Rails sites, using SPF.js — a library for dynamic page updates from Youtube."><link rel="alternate" type="application/rss+xml" href="http://lorefnon.me/feed.xml"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/reset.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/responsive.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/github.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/minimal_lightbox.css"/><link rel="stylesheet" media="screen" type="text/css" href="/assets/stylesheets/styles.css"/><link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"><link href="//fonts.googleapis.com/css?family=Raleway" rel='stylesheet' type='text/css'> <script>this.top.location!==this.location&&(this.top.location=this.location)</script></head><body style="zoom:1"><div class="main-container"><div class="mlogotype is-uppercase"> <a href="http://lorefnon.me">Code.Art.Web</a></div><a href="http://lorefnon.me" class="home_logotype_link"><h1 class="tag">Code.Art.Web</h1> </a><div class="header-container detail-view"> <header class="main-header"> <figure class="avatar"> <a href="http://lorefnon.me" style="background-image:url('')">Profile Picture</a> </figure><h1 class="profile-name is-uppercase"> <a href="http://lorefnon.me">Lorefnon</a></h1> </header></div><div class="posts-container detail-view"> <article class="post detail-view" id=""><h1 class="title"><a href="#">Boost your content focussed site with Structured Page Fragments</a></h1> <a href="#" class="anchor-icon time-wrapper"> <i class="fa fa-anchor"></i> <time>Nov 26, 2015</time> </a><h2> <a class="header-link" href="#abstract" id="abstract"> Abstract </a></h2><p>Eliminate full page refreshes and reduce page transition latency, in your your Rails sites, using SPF.js — a library for dynamic page updates from Youtube.</p><h2><a class="header-link" href="#header1-1" id="header1-1"><span class="header-bullet-num">1.</span><span class="header-inner-text">The context</span></a></h2><p><a href="https://youtube.github.io/spfjs/">SPF.js</a> a lightweight javascript library to incorporate dynamic page updates that dramatically reduces perceived page latency. Quoting from the Repo Homepage:</p><blockquote><p>Using progressive enhancement and HTML5, SPF integrates with your site to enable a faster, more fluid user experience by updating just the sections of the page that change during navigation, not the whole page. SPF provides a response format for sending document fragments, a robust system for script and style management, an in-memory cache, on-the-fly processing, and more.</p></blockquote><p>While for complex dynamic sites which have a significant amount of client side logic, I still recommend adopting a client side javascript framework, but for content focussed sites, a nifty utility like SPF.js can be very useful.</p><h2><a class="header-link" href="#header1-2" id="header1-2"><span class="header-bullet-num">2.</span><span class="header-inner-text">Why not good old js.erb templates ?</span></a></h2><p>While Rails allows us to render server generated javascript templates, using them to generate dynamic page updates is a bit cumbersome for most scenarios. Especially you have to handle page url updates manually, scroll back the pages manually etc. None of them are very complex concerns, but having a library deal with such cross cutting concerns is much more elegant IMHO.</p><h2><a class="header-link" href="#header1-3" id="header1-3"><span class="header-bullet-num">3.</span><span class="header-inner-text">What about turbolinks ?</span></a></h2><p>While yes, <a href="https://github.com/rails/turbolinks">turbolinks</a> does enjoy being a part of the default Rails stack, but frankly, it has always seemed like a half baked product. While turbolinks does improve the experience over full page reloads, behind the scenes it still loads the full page content.</p><p>SPF.js allows you to just fetch the parts of the page that really need updating. The GIF below, also taken from the official site, explains this much better:</p><h3><a class="header-link" href="#header1-3-1" id="header1-3-1"><span class="header-bullet-num">3.1.</span><span class="header-inner-text">Full page re-rendering</span></a></h3><p><img src="/images/animation-static-340x178.gif"></p><h3><a class="header-link" href="#header1-3-2" id="header1-3-2"><span class="header-bullet-num">3.2.</span><span class="header-inner-text">Partial section replacement with SPF.js</span></a></h3><p><img src="/images/animation-dynamic-340x178.gif"></p><h2><a class="header-link" href="#header1-6" id="header1-6"><span class="header-bullet-num">4.</span><span class="header-inner-text">But doesn't the latest version of turbolinks include support for partial page replacement ?</span></a></h2><p>Yes, but there is a <a href="https://github.com/rails/turbolinks/issues/628">lack of clarity</a> over when (and if) that feature will be officially released.</p><p>In a nutshell, the version of turbolinks that is scheduled to ship with Rails 5, significantly diverges from what has hitherto been considered as the <a href="https://github.com/rails/turbolinks/">official turbolinks repo</a>, and will probably not contain, among other features, support for partial page replacements. While the future is not set in stone, and as DHH has <a href="https://github.com/rails/turbolinks/issues/628#issuecomment-157376926">put it</a>:</p><blockquote><p>But, hey, it's just code. If the current state of this repo serves your needs, you don't need any official blessing from anyone to use it. You can use it as-is, you can fork, you can do whatever you want. MIT baby!</p></blockquote><p>While I appreciate the freedom associated with open source licenses, I would rather bet on a well supported library that caters to the exact same use case and which is already being used in production in a wildly popular site - Youtube.</p><h2><a class="header-link" href="#header1-7" id="header1-7"><span class="header-bullet-num">5.</span><span class="header-inner-text">Integrating SPF.js with Rails</span></a></h2><p>The rest of the post outlines the steps required to integrate SPF.js with a rails application. The code for this tutorial is available in <a href="https://github.com/lorefnon/rails-spfjs-demo">Github</a>.</p><p>We will create a dummy blog application. But hey, since this is just a demo application, we can get away with a little <a href="https://github.com/sevenwire/forgery">Forgery</a>:</p><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@page</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">].</span><span class="n">to_i</span>
    <span class="vi">@num_pages</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="mi">10</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">fake_post_summary</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@post</span> <span class="o">=</span> <span class="n">fake_post</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">fake_post</span>
    <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span> <span class="n">fake_post_summary</span><span class="o">.</span><span class="n">to_h</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span>
      <span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">body</span><span class="p">:</span> <span class="no">LoremIpsum</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="ss">paragraphs</span><span class="p">:</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
    <span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">fake_post_summary</span>
    <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
      <span class="nb">id</span><span class="p">:</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
      <span class="ss">title</span><span class="p">:</span> <span class="no">LoremIpsum</span><span class="o">.</span><span class="n">lorem_ipsum</span><span class="p">(</span><span class="ss">words</span><span class="p">:</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span>
      <span class="ss">summary</span><span class="p">:</span> <span class="no">LoremIpsum</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="ss">paragraphs</span><span class="p">:</span> <span class="mi">1</span><span class="p">),</span>
      <span class="ss">author</span><span class="p">:</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">user_name</span><span class="p">:</span> <span class="no">Forgery</span><span class="p">(</span><span class="s1">'internet'</span><span class="p">)</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
        <span class="ss">email</span><span class="p">:</span> <span class="no">Forgery</span><span class="p">(</span><span class="s1">'internet'</span><span class="p">)</span><span class="o">.</span><span class="n">email_address</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div><p>So now that we have our dummy posts in place, we just need to show them:</p><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;!-- posts/index.html.erb --&gt;</span>
<span class="x">&lt;div class="blog-container"&gt;</span>

<span class="x">  &lt;h1 class="blog-title title"&gt; Lorefnon's Awesome blog &lt;/h1&gt;</span>
<span class="x">  &lt;h2 class="page-title title"&gt; Posts &lt;/h2&gt;</span>

<span class="x">  &lt;div class="posts-container"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'posts/posts'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>

<span class="x">&lt;/div&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;!-- posts/_posts.html.erb --&gt;</span>
<span class="x">&lt;ul class="posts-list"&gt;</span>

<span class="x">  &lt;div class="posts"&gt;</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="vi">@posts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'posts/summary'</span><span class="p">,</span> <span class="ss">post</span><span class="p">:</span> <span class="n">post</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/div&gt;</span>

<span class="x">&lt;/ul&gt;</span>

<span class="x">&lt;div class="navigation-links"&gt;</span>
<span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'posts/navigation_links'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;!-- posts/_summary.html.erb --&gt;</span>
<span class="x">&lt;li data-post-id="</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span>
<span class="x">  &lt;h3 class="title post-title"&gt; </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> &lt;/h3&gt;</span>
<span class="x">  &lt;p&gt; </span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">summary</span> <span class="cp">%&gt;</span><span class="x"> &lt;/p&gt;</span>
<span class="x">&lt;/li&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;!-- posts/_navigation_links.html.erb --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@page</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">   </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Previous Page'</span><span class="p">,</span> <span class="n">posts_path</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="vi">@page</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@page</span> <span class="o">&lt;</span> <span class="vi">@num_pages</span> <span class="o">-</span><span class="mi">1</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">   </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Next Page'</span><span class="p">,</span> <span class="n">posts_path</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="vi">@page</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</code></pre></div><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;!-- posts/show.html.erb --&gt;</span>
<span class="x">&lt;div class="blog-container"&gt;</span>
<span class="x">  &lt;h2 class="post-title title"&gt; </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="vi">@post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="vi">@post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> &lt;/h2&gt;</span>
<span class="x">  &lt;div class="post-body"&gt; </span><span class="cp">&lt;%=</span> <span class="vi">@post</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span><span class="x"> &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</code></pre></div><p>The above templates have nothing particularly characteristic. If you would have written them yourself, I guess you would have implemented something very similar. I have presented above to particularly highlight that the way you structure your views does not need to be drastically altered to use SPF.js. Hence it is easy to take your existing sites and start using SPF.js.</p><p>Our dummy blog looks something like this now:</p><p><img src="/images/2015-11-26/blog_index.png" data-action="zoom"></p><h2><a class="header-link" href="#header1-8" id="header1-8"><span class="header-bullet-num">6.</span><span class="header-inner-text">Including SPF</span></a></h2><p>Next step for us is to include SPF.js in the page. For that we will just add the cdn link to our layout. Other methods of including are available <a href="https://github.com/youtube/spfjs#download">here</a>.</p><p>After this inclusion our template might look something like this:</p><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;!DOCTYPE html&gt;</span>

<span class="x">&lt;html&gt;</span>

<span class="x">  &lt;head&gt;</span>
<span class="x">    &lt;title&gt;Rails Spfjs Demo&lt;/title&gt;</span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'//ajax.googleapis.com/ajax/libs/spf/2.3.0/spf.js'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media</span><span class="p">:</span> <span class="s1">'all'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'application'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/head&gt;</span>

<span class="x">  &lt;body&gt;</span>

<span class="x">  </span><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">  &lt;script&gt;</span>
<span class="x">    spf.init();</span>
<span class="x">  &lt;/script&gt;</span>

<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</code></pre></div><h2><a class="header-link" href="#header1-9" id="header1-9"><span class="header-bullet-num">7.</span><span class="header-inner-text">Making navigation links SPF aware</span></a></h2><p>However just initializing SPF.js does not magically ajaxify all navigation links. In fact, so far SPF.js has not altered the navigation in any way.</p><p>We need to explicitly enable SPFjs for links for which our server knows how to serve partial content. For SPF to process a link, it should have the class 'spf-link'. Let us start with our navigation links:</p><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@page</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">   </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Previous Page'</span><span class="p">,</span> <span class="n">posts_path</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="vi">@page</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'spf-link'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@page</span> <span class="o">&lt;</span> <span class="vi">@num_pages</span> <span class="o">-</span><span class="mi">1</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">   </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Next Page'</span><span class="p">,</span> <span class="n">posts_path</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="vi">@page</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'spf-link'</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</code></pre></div><p>One great feature of SPF.js is that it handles graceful degradation. So, since we haven't done anything on the server side to generate partial contents, SPF will try to make an ajax request to server (with the special query parameter <code>spf-navigate</code>) and once that response format does not match what SPF expects, it will allow a full page reload.</p><h2><a class="header-link" href="#header1-10" id="header1-10"><span class="header-bullet-num">8.</span><span class="header-inner-text">Server side handling for SPF</span></a></h2><p>Let us move on to server side handling:</p><p>As we have previously mentioned that SPF sends an ajax request using spf=navigate query parameter. We can detect that in our controller and send out a special response that only includes the parts of the page we need to update:</p><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@page</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">].</span><span class="n">to_i</span>
    <span class="vi">@num_pages</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="mi">10</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">fake_post_summary</span> <span class="p">}</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:spf</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'navigate'</span>
      <span class="n">render</span> <span class="s1">'posts/index.json'</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre></div><p>Next we will have to designate the parts that can be dynamically replace using an id. In our modified <code>posts/_summary.html.erb</code> below, <code>spf-posts-container</code> serves that purpose:</p><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">&lt;li data-post-id="</span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="x">"&gt;</span>
<span class="x">  &lt;h3 class="title post-title"&gt; </span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">post</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"> &lt;/h3&gt;</span>
<span class="x">  &lt;p&gt; </span><span class="cp">&lt;%=</span> <span class="n">post</span><span class="o">.</span><span class="n">summary</span> <span class="cp">%&gt;</span><span class="x"> &lt;/p&gt;</span>
<span class="x">&lt;/li&gt;</span>
</code></pre></div><p>While SPF does not require DOM node IDs to begin with <code>spf-</code> prefix I think this is a good convention and makes the intent explict.</p><p>Finally here is our json template that contains the partial page update, in the format that SPF.js <a href="https://youtube.github.io/spfjs/documentation/responses/">can process</a>.</p><p>index.json.erb:</p><div class="highlight"><pre><code class="erb language-erb" data-lang="erb"><span class="x">{</span>
<span class="x">  "body": {</span>
<span class="x">    "spf-posts-container": "</span><span class="cp">&lt;%=</span> <span class="n">j</span> <span class="n">render</span> <span class="s1">'posts/posts'</span> <span class="cp">%&gt;</span><span class="x">"</span>
<span class="x">  }</span>
<span class="x">}</span>
</code></pre></div><p>While we are using a simple <code>json.erb</code> template, it should be noted that any generic approach that can generate json response in rails, works well. So if you are already using <code>rabl</code> or <code>jbuilder</code> in your APIs, you can continue using that.</p><p>Now when a navigation link is clicked, the json response is fetched via ajax and the page is dynamically updated - resulting in a much smoother user experience.</p><p>Also note that browser url has been automatically updated and the page scrolls to the top. SPF tries to emulate the experience the experience of page change as much as possible to prevent uncanny surprises.</p><p><img src="/images/2015-11-26/spf_response.png" data-action="zoom"></p><h2><a class="header-link" href="#header1-11" id="header1-11"><span class="header-bullet-num">9.</span><span class="header-inner-text">(Optional) Leveraging rails magic for leaner controllers</span></a></h2><p>While the above works, it is unweildy to handle the navigation link in each controller. We can alternatively make the <code>default_render</code> method that is used by rails to be SPF aware. The <a href="https://github.com/rails/rails/blob/7f18ea14c893cb5c9f04d4fda9661126758332b5/actionpack/lib/action_controller/metal/implicit_render.rb">default implementation</a> looks like this:</p><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">default_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">template_exists?</span><span class="p">(</span><span class="n">action_name</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">_prefixes</span><span class="p">,</span> <span class="ss">variants</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">variant</span><span class="p">)</span>
    <span class="n">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="k">yield</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">"No template found for </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\#</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">, rendering head :no_content"</span> <span class="k">if</span> <span class="n">logger</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>We can override this in our ApplicationController</p><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="c1"># Prevent CSRF attacks by raising an exception.</span>
  <span class="c1"># For APIs, you may want to use :null_session instead.</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>

  <span class="k">def</span> <span class="nf">default_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:spf</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'navigate'</span>
      <span class="n">render</span> <span class="s2">"</span><span class="si">#{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">/spf_</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">.json"</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div><p>Now all we have to do is prefix the names of our SPF specific templates with <code>spf_</code> and we are done. Our <code>spf_index.json.erb</code> remains unchanged.</p><p>We can clean up the action and remove SPF specific code:</p><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@page</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">].</span><span class="n">to_i</span>
    <span class="vi">@num_pages</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="mi">10</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">fake_post_summary</span> <span class="p">}</span>
  <span class="k">end</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre></div><h2><a class="header-link" href="#header1-12" id="header1-12"><span class="header-bullet-num">10.</span><span class="header-inner-text">Navigation hooks</span></a></h2><p>While so far everything works pretty well, we may want to hook into navigation events for greater flexibility. This may be useful for sending events to analytics service or for highlighting specific parts of page. The latter is useful because in some cases when the part replaced is very small, users might not immediate notice a quick change in the page content.</p><p>For instance <code>spfdone</code> event is invoked after the asynchronous update has been applied to the page. We can attach handlers to this event just like any other event, and hook custom logic:</p><p><img src="/images/2015-11-26/spfdone.png" data-action="zoom"></p><p>Let us highlight the listing of our posts using CSS 3 animations when loaded asynchronously:</p><div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'spfdone'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="s1">'spf-posts-container'</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#spf-posts-container'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">)</span>

    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#spf-posts-container'</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">)</span>
    <span class="p">},</span> <span class="mi">3000</span><span class="p">)</span>

  <span class="p">}</span>

<span class="p">});</span>
</code></pre></div><div class="highlight"><pre><code class="css language-css" data-lang="css"><span class="nc">.flash</span> <span class="p">{</span>
  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">animation</span><span class="o">:</span> <span class="n">flash</span> <span class="m">1s</span> <span class="n">ease</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">animation</span><span class="o">-</span><span class="n">iteration</span><span class="o">-</span><span class="n">count</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>

  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">animation</span><span class="o">:</span> <span class="n">flash</span> <span class="m">1s</span> <span class="n">ease</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">animation</span><span class="o">-</span><span class="n">iteration</span><span class="o">-</span><span class="n">count</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>

  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="n">animation</span><span class="o">:</span> <span class="n">flash</span> <span class="m">1s</span> <span class="n">ease</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="n">animation</span><span class="o">-</span><span class="n">iteration</span><span class="o">-</span><span class="n">count</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@-webkit-keyframes</span> <span class="nt">flash</span> <span class="p">{</span>
    <span class="nt">0</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">50</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="m">#fbf8b2</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">100</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">@-moz-keyframes</span> <span class="nt">flash</span> <span class="p">{</span>
    <span class="nt">0</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">50</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="m">#fbf8b2</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">100</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">@-ms-keyframes</span> <span class="nt">flash</span> <span class="p">{</span>
    <span class="nt">0</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">50</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="m">#fbf8b2</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">100</span><span class="o">%</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Now you should see a subtle flash when page content has been replaced.</p><h2><a class="header-link" href="#header1-13" id="header1-13"><span class="header-bullet-num">11.</span><span class="header-inner-text">Conclusion</span></a></h2><p>This concludes our small post on SPF integration with Rails. SPF allows for a lot more customization options beyond what our small covers. In particular SPF allows us to inject new scripts and styles dynamically, sophisticated <a href="https://youtube.github.io/spfjs/documentation/caching/">cache management</a> and <a href="https://youtube.github.io/spfjs/documentation/versioning/">resource versioning</a> support, which are all very useful features.</p><p>The <a href="https://youtube.github.io/spfjs/documentation">official documentation</a> is a great place to start exploring more.</p><footer class="group"><p></p> </footer><div id="disqus_thread"></div> <script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//lorefnon-blog.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" class="disqus-link">comments powered by Disqus.</a> </noscript> <a href="http://disqus.com" class="dsq-brlink disqus-link">comments powered by <span class="logo-disqus">Disqus</span></a></article></div><div class="line hide-text">Separator line</div><div class="next-article" style="display:none"> <a href="#"><p class="read-next tag is-uppercase">Read this next:</p><p class="next-article__title">Protocol and Language</p><div class="next-article__content"><p>This is the second part of my series on protocol. The first part contained a lot of background information, but now we’re ready to get into what Protocol actually is. I live in a pretty unique place, the Farmhouse. It’s a... <span>Continue…</span></p></div> </a></div><div class="line hide-text">Separator line</div><div class="foot_logo"> <a href="http://lorefnon.me"><span class="logo"></span></a></div><div class="foot_logo right"> <a href="/"><span class="link">Full Blog >></span></a></div><div class="line"></div><div class="foot_userbar"><div href="#" class="bottom_tagline"> <span>Lorefnon</span> <br><br><p> Full stack web developer and polyglot programmer with strong interest in dynamic languages, web application development and user experience design.</p> <br><p> Strong believer in agile methodologies, behaviour driven development and efficacy of open source technologies.</p> <br></div><div class="profile-links-container"> <a href="#" class="bottom_tagline"><span> You can reach me through :</span></h2> <br><br><ul class="profile-links"><li class="twitter"> <a href="http://twitter.com/lorefnon" target="_blank"> <span>Twitter</span> </a></li><li class="linkedin"> <a href="https://in.linkedin.com/in/gaurab-paul-a2472921" target="_blank"> <span>Linkedin</span> </a></li><li class="github"> <a href="https://github.com/lorefnon" target="_blank"> <span>Github</span> </a></li><li class="github"> <a href="mailto:lorefnon@gmail.com" target="_blank"> <span>Email</span> </a></li></ul></div></div><div class="line"></div><div class="foot_userbar"><p>© 2013 - 2015 Gaurab Paul</p> <br/><p>Code licensed under the <a href="http://opensource.org/licenses/MIT" target="_blank">The MIT License</a>. Content and Artwork licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA</a>.</p> <br/><p> The opinions expressed herein are my personal viewpoints and may not be taken as professional recommendations from any of my previous or current employers.</p> <br/><p> Site is powered by <a href="http://jekyllrb.com/">Jekyll</a> and graciously hosted by <a href="https://github.com">Github</a></p> <br/> <br/></div></div><script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-47274059-1"]),_gaq.push(["_setDomainName","lorefnon.me"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="/assets/javascripts/post.js"></script></body></html>